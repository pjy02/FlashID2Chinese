const API_KEYS={WINDOWS:"AIzaSyA2KlwBX3mkFo30om9LUFYQhpqLoa_BNhE",LINUX:"AIzaSyBqJZh-7pA44blAaAkH6490hUFOwX0KCYM",MACOS:"AIzaSyDr2UxVnv_U85AbhhY8XSHSIavUW0DC-sY"},URL_RULES=[{id:1,name:"google",regex:"^https?://([a-z0-9-]+\\.)?google\\.[a-z]{2,}(\\.[a-z]{2,})?(?:/|$)"},{id:2,name:"youtube",regex:"^https?://([a-z0-9-]+\\.)?youtube\\.[a-z]{2,}(\\.[a-z]{2,})?(?:/|$)"},{id:3,name:"chromeWebstore",regex:"^https?://chromewebstore\\.google\\.com(?:/|$)"}];function getChromeVersion(e){const t=e.match(/Chrome\/(\d+)\./);return t?parseInt(t[1],10):0}function getOperatingSystem(e){const t=e.toLowerCase();return t.includes("windows")?"WINDOWS":t.includes("linux")?"LINUX":"MACOS"}async function calculateValidationHash(){const e=navigator.userAgent,t=getOperatingSystem(e),r=API_KEYS[t],a=getChromeVersion(e)>131?"2025":"2024",o=`${r}${e}`,s=(new TextEncoder).encode(o),c=await crypto.subtle.digest("SHA-1",s),i=Array.from(new Uint8Array(c)).map(e=>String.fromCharCode(e)).join("");return{hash:btoa(i),year:a}}async function generateRules(){const{hash:e,year:t}=await calculateValidationHash(),r=[{header:"x-browser-channel",operation:chrome.declarativeNetRequest.HeaderOperation.SET,value:"stable"},{header:"x-browser-copyright",operation:chrome.declarativeNetRequest.HeaderOperation.SET,value:`Copyright ${t} Google LLC. All rights reserved.`},{header:"x-browser-validation",operation:chrome.declarativeNetRequest.HeaderOperation.SET,value:e},{header:"x-browser-year",operation:chrome.declarativeNetRequest.HeaderOperation.SET,value:t}],a=[chrome.declarativeNetRequest.ResourceType.MAIN_FRAME,chrome.declarativeNetRequest.ResourceType.SUB_FRAME,chrome.declarativeNetRequest.ResourceType.STYLESHEET,chrome.declarativeNetRequest.ResourceType.SCRIPT,chrome.declarativeNetRequest.ResourceType.IMAGE,chrome.declarativeNetRequest.ResourceType.FONT,chrome.declarativeNetRequest.ResourceType.OBJECT,chrome.declarativeNetRequest.ResourceType.XMLHTTPREQUEST,chrome.declarativeNetRequest.ResourceType.PING,chrome.declarativeNetRequest.ResourceType.CSP_REPORT,chrome.declarativeNetRequest.ResourceType.MEDIA,chrome.declarativeNetRequest.ResourceType.WEBSOCKET,chrome.declarativeNetRequest.ResourceType.WEBTRANSPORT,chrome.declarativeNetRequest.ResourceType.WEBBUNDLE,chrome.declarativeNetRequest.ResourceType.OTHER];return URL_RULES.map(e=>({id:e.id,priority:1,action:{type:chrome.declarativeNetRequest.RuleActionType.MODIFY_HEADERS,requestHeaders:r},condition:{regexFilter:e.regex,resourceTypes:a}}))}async function updateHeaderRules(){try{const e=await generateRules(),t=URL_RULES.map(e=>e.id);await chrome.declarativeNetRequest.updateDynamicRules({removeRuleIds:t,addRules:e}),console.log("[Tab Assistant] Rules updated successfully")}catch(e){console.error("[Tab Assistant] Failed to update rules:",e)}}chrome.runtime.onInstalled.addListener(()=>{console.log("[Tab Assistant] Extension installed/updated"),updateHeaderRules()}),chrome.runtime.onStartup.addListener(()=>{console.log("[Tab Assistant] Browser started"),updateHeaderRules()}),console.log("[Tab Assistant] Service Worker loaded, initializing rules..."),updateHeaderRules();