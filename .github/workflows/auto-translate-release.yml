name: Build and Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g. 1.2.3)'
        required: true
        type: string

jobs:
  build-release:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Prepare translated app.asar
        shell: bash
        run: |
          node scripts/prepare-asar.js "${{ inputs.version }}"

      - name: Build release binary
        shell: bash
        run: cargo build --release

      - name: Package artifacts
        shell: bash
        run: |
          mkdir -p dist
          cp target/release/FlashID2Chinese.exe "dist/FlashID2Chinese-${{ inputs.version }}.exe"
          cp app.asar "dist/app.asar"
          cp dist/app.asar app.asar

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v${{ inputs.version }}"
          name: "v${{ inputs.version }}"
          body: |
            ## FlashID ä¸­æ–‡æ±‰åŒ– v${{ inputs.version }}
            
            ### ğŸ“¦ å‘å¸ƒå†…å®¹
            
            - **FlashID2Chinese-${{ inputs.version }}.exe** - æ±‰åŒ–å·¥å…·ï¼ˆæ¨èä½¿ç”¨ï¼‰
              - å°†æ­¤ç¨‹åºæ”¾åˆ° FlashID å®‰è£…ç›®å½•
              - ä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œ
              - è‡ªåŠ¨å®Œæˆæ±‰åŒ–
            
            - **app.asar** - æ±‰åŒ–åçš„èµ„æºæ–‡ä»¶
              - æ‰‹åŠ¨æ›¿æ¢ä½¿ç”¨
              - å¤‡ä»½åŸ `resources/app.asar` åæ›¿æ¢æ­¤æ–‡ä»¶
            
            ### ğŸ“ ä½¿ç”¨è¯´æ˜
            
            **æ–¹å¼ä¸€ï¼šä½¿ç”¨æ±‰åŒ–å·¥å…·ï¼ˆæ¨èï¼‰**
            1. ä¸‹è½½ `FlashID2Chinese-${{ inputs.version }}.exe`
            2. å°†å…¶ç§»åŠ¨åˆ° FlashID å®‰è£…ç›®å½•ï¼ˆé€šå¸¸åœ¨ `C:\Program Files\FlashID` æˆ– `C:\Users\ä½ çš„ç”¨æˆ·å\AppData\Local\Programs\FlashID`ï¼‰
            3. å³é”® â†’ ä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œ
            4. ç­‰å¾…æç¤º"æ±‰åŒ–å®Œæˆ"
            5. é‡å¯ FlashID å³å¯
            
            **æ–¹å¼äºŒï¼šæ‰‹åŠ¨æ›¿æ¢ app.asar**
            1. ä¸‹è½½ `app.asar`
            2. æ‰¾åˆ° FlashID å®‰è£…ç›®å½•ä¸‹çš„ `resources` æ–‡ä»¶å¤¹
            3. å¤‡ä»½åŸ `app.asar` æ–‡ä»¶ï¼ˆé‡å‘½åä¸º `app.asar.backup`ï¼‰
            4. å°†ä¸‹è½½çš„æ–‡ä»¶æ›¿æ¢åŸ `app.asar`
            5. é‡å¯ FlashID å³å¯
            
            ### âš ï¸ æ³¨æ„äº‹é¡¹
            
            - è¯·ç¡®ä¿ä¸‹è½½çš„ç‰ˆæœ¬å·ä¸ä½ çš„ FlashID ç‰ˆæœ¬ä¸€è‡´
            - æ±‰åŒ–å‰å»ºè®®å¤‡ä»½åŸæ–‡ä»¶
            - å¦‚é‡é—®é¢˜ï¼Œå¯æ¢å¤å¤‡ä»½æ–‡ä»¶
            
            ---
            
            ğŸ’¬ å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œæ¬¢è¿åœ¨ Issues ä¸­åé¦ˆï¼
          files: |
            dist/FlashID2Chinese-${{ inputs.version }}.exe
            dist/app.asar
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
